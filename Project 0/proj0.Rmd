---
title: "proj0"
output: html_document
---

```{r}
library(tidyverse)    # Data manipulation and visualization
library(lubridate)    # Date/time handling
library(gridExtra)    # Arranging multiple plots
library(knitr)        # Tables
library(kableExtra)   # Enhanced tables
library(scales)       # Axis formatting
library(lme4)
```
good adherence: within 7.5min before/after the timepoint
adequate adherence: +- 15min

dont use MEMs/Booklet sample interval time

use nmol/L units

Consider excluding super high DHEA level

# q1

mixed model
correlation
take average in difference


## Data cleaning

```{r}
data_raw<-read.csv("Project0_Clean_v2.csv")
head(data_raw)

data <- data_raw %>%
  rename(
    SubjectID = SubjectID,
    CollectionDate = Collection.Date,
    CollectionSample = Collection.Sample,
    Booklet_ClockTime = Booket..Clock.Time,           # Note: typo in original "Booket"
    MEMs_ClockTime = MEMs..Clock.Time,
    SleepDiary_WakeTime = Sleep.Diary.reported.wake.time,
    Booklet_SampleInterval = Booklet..Sample.interval,
    Booklet_SampleInterval_Mins = Booklet..Sample.interval.Decimal.Time..mins.,
    MEMs_SampleInterval = MEMs..Sample.interval,
    MEMs_SampleInterval_Mins = MEMs..Sample.interval.Decimal.Time..mins.,
    Cortisol_ugdl = Cortisol..ug.dl.,
    DHEA_pgdl = DHEA..pg.dl.,
    Cortisol_nmolL = Cortisol..nmol.L.,
    DHEA_nmolL = DHEA..nmol.L.,
    DayNumber = DAYNUMB
  )

## DATE/TIME HANDLING
# Function to parse time strings (handles hh:mm format)
parse_time_hhmm <- function(time_str) {
  # Return NA for empty strings or NA values
  if (is.na(time_str) || time_str == "") {
    return(NA)
  }
  # Parse hh:mm format
  parsed <- hm(time_str)
  return(parsed)
}

# Function to convert time string to minutes since midnight
time_to_minutes <- function(time_str) {
  if (is.na(time_str) || time_str == "") {
    return(NA)
  }
  parts <- strsplit(time_str, ":")[[1]]
  if (length(parts) >= 2) {
    hours <- as.numeric(parts[1])
    mins <- as.numeric(parts[2])
    return(hours * 60 + mins)
  }
  return(NA)
}

# Apply time conversion to create minutes since midnight for clock times
data <- data %>%
  mutate(
    # Convert clock times to minutes since midnight
    Booklet_ClockTime_Mins = sapply(Booklet_ClockTime, time_to_minutes),
    MEMs_ClockTime_Mins = sapply(MEMs_ClockTime, time_to_minutes),
    WakeTime_Mins_Raw = sapply(SleepDiary_WakeTime, time_to_minutes)
  )

# Calculate time since waking
data <- data %>%
  mutate(
    # Time since waking calculated from clock times minus wake time
    Booklet_TimeSinceWaking = Booklet_ClockTime_Mins - WakeTime_Mins_Raw,
    MEMs_TimeSinceWaking = MEMs_ClockTime_Mins - WakeTime_Mins_Raw
  )



data <- data %>%
  group_by(SubjectID, DayNumber) %>%
  mutate(
    # Fill wake time: take the non-NA value from Sample 1 and apply to all samples
    WakeTime_Mins = WakeTime_Mins_Raw[CollectionSample == 1][1]
  ) %>%
  ungroup()

data <- data %>%
  mutate(
    # Time since waking calculated from clock times minus wake time
    Booklet_TimeSinceWaking = Booklet_ClockTime_Mins - WakeTime_Mins,
    MEMs_TimeSinceWaking = MEMs_ClockTime_Mins - WakeTime_Mins
  )

head(data)
```

```{r}
## EXCLUDE EXTREME VALUES

# Flag/exclude implausible cortisol values
# - Values > 80 nmol/L are lab errors (EXCLUDE)
# - Values > 26 nmol/L are high but biologically possible (FLAG)
data <- data %>%
  mutate(
    Cortisol_LabError = Cortisol_nmolL > 80,
    Cortisol_High = Cortisol_nmolL > 26 & Cortisol_nmolL <= 80,
    # Flag the extreme cortisol value (9999 appears to be an error code)
    Cortisol_LabError = ifelse(Cortisol_nmolL > 1000, TRUE, Cortisol_LabError)
  )

# Flag DHEA at detection limit (5.205 nmol/L)
data <- data %>%
  mutate(
    DHEA_AtDetectionLimit = abs(DHEA_nmolL - 5.205) < 0.001
  )

# Identify subjects with multiple DHEA at detection limit
subjects_multiple_DHEA_limit <- data %>%
  filter(DHEA_AtDetectionLimit) %>%
  group_by(SubjectID) %>%
  summarise(n_at_limit = n()) %>%
  filter(n_at_limit > 1)


data <- data %>%
  mutate(
    SubjectID_Factor = as.factor(SubjectID),
    CollectionSample_Factor = factor(CollectionSample, 
                                      levels = 1:4,
                                      labels = c("Waking", "30 min", "Lunch", "10 hours")),
    DayNumber_Factor = factor(DayNumber, levels = 1:3, labels = c("Day 1", "Day 2", "Day 3"))
  )

head(data)


missing_summary <- data %>%
  summarise(
    Total_Observations = n(),
    Missing_Booklet_ClockTime = sum(is.na(Booklet_ClockTime_Mins)),
    Missing_MEMs_ClockTime = sum(is.na(MEMs_ClockTime_Mins)),
    Missing_WakeTime = sum(is.na(WakeTime_Mins)),
    Missing_Cortisol = sum(is.na(Cortisol_nmolL)),
    Missing_DHEA = sum(is.na(DHEA_nmolL)),
    Excluded_Cortisol_LabError = sum(Cortisol_LabError, na.rm = TRUE),
    Excluded_DHEA_DetectionLimit = sum(DHEA_AtDetectionLimit, na.rm = TRUE)
  )

missing_summary_long <- missing_summary %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Count") %>%
  mutate(Percentage = round(100 * Count / missing_summary$Total_Observations, 1))

print(missing_summary_long)

missing_heatmap_data <- data %>%
  mutate(
    MEMs_Missing = ifelse(is.na(MEMs_ClockTime_Mins), 1, 0)
  ) %>%
  select(SubjectID, DayNumber, CollectionSample, MEMs_Missing)

plot_missing_heatmap <- ggplot(missing_heatmap_data, 
                                aes(x = factor(CollectionSample), 
                                    y = factor(SubjectID),
                                    fill = factor(MEMs_Missing))) +
  geom_tile(color = "white") +
  facet_wrap(~ factor(DayNumber, labels = c("Day 1", "Day 2", "Day 3"))) +
  scale_fill_manual(values = c("0" = "steelblue", "1" = "tomato"),
                    labels = c("Present", "Missing"),
                    name = "MEMs Time") +
  labs(title = "Missing MEMs Clock Times by Subject, Day, and Sample",
       x = "Collection Sample",
       y = "Subject ID") +
  theme(axis.text.y = element_text(size = 6))

print(plot_missing_heatmap)
ggsave("missing_data_heatmap.png", plot_missing_heatmap, width = 12, height = 10, dpi = 150)
```

```{r}
# Q1 DESCRIPTIVE STATISTICS

data_paired <- data %>%
  filter(!is.na(Booklet_TimeSinceWaking) & !is.na(MEMs_TimeSinceWaking))

data_paired <- data_paired %>%
  mutate(
    # Difference: Booklet - MEMs (positive = Booklet later than MEMs)
    Time_Difference = Booklet_TimeSinceWaking - MEMs_TimeSinceWaking,
    # Average of the two measurements (for Bland-Altman)
    Time_Average = (Booklet_TimeSinceWaking + MEMs_TimeSinceWaking) / 2,
    # Absolute difference
    Abs_Difference = abs(Time_Difference)
  )



diff_summary_overall <- data_paired %>%
  summarise(
    N = n(),
    Mean_Diff = mean(Time_Difference, na.rm = TRUE),
    SD_Diff = sd(Time_Difference, na.rm = TRUE),
    Median_Diff = median(Time_Difference, na.rm = TRUE),
    IQR_Diff = IQR(Time_Difference, na.rm = TRUE),
    Min_Diff = min(Time_Difference, na.rm = TRUE),
    Max_Diff = max(Time_Difference, na.rm = TRUE),
    Mean_Abs_Diff = mean(Abs_Difference, na.rm = TRUE)
  )

cat("--- Overall Time Difference (Booklet - MEMs, in minutes) ---\n")
print(diff_summary_overall)

# Calculate 95% Limits of Agreement
mean_diff <- diff_summary_overall$Mean_Diff
sd_diff <- diff_summary_overall$SD_Diff
LoA_lower <- mean_diff - 1.96 * sd_diff
LoA_upper <- mean_diff + 1.96 * sd_diff

cat("\n--- Bland-Altman Statistics ---\n")
cat("Mean Difference (Bias):", round(mean_diff, 2), "minutes\n")
cat("95% Limits of Agreement:", round(LoA_lower, 2), "to", round(LoA_upper, 2), "minutes\n")

# -----------------------------------------------------------------------------
# 3.4 Summary by Collection Sample
# -----------------------------------------------------------------------------
diff_summary_by_sample <- data_paired %>%
  group_by(CollectionSample_Factor) %>%
  summarise(
    N = n(),
    Mean_Diff = round(mean(Time_Difference), 2),
    SD_Diff = round(sd(Time_Difference), 2),
    Median_Diff = round(median(Time_Difference), 2),
    Min_Diff = round(min(Time_Difference), 2),
    Max_Diff = round(max(Time_Difference), 2)
  )

cat("\n--- Time Difference by Collection Sample ---\n")
print(diff_summary_by_sample)


# -----------------------------------------------------------------------------
# 3.5 Correlation between Booklet and MEMs times
# -----------------------------------------------------------------------------
correlation_test <- cor.test(data_paired$Booklet_TimeSinceWaking, 
                              data_paired$MEMs_TimeSinceWaking,
                              method = "pearson")

cat("\n--- Pearson Correlation ---\n")
cat("Correlation coefficient (r):", round(correlation_test$estimate, 4), "\n")
cat("95% CI:", round(correlation_test$conf.int[1], 4), "to", 
    round(correlation_test$conf.int[2], 4), "\n")
cat("p-value:", format.pval(correlation_test$p.value, digits = 3), "\n")

# -----------------------------------------------------------------------------
# 3.6 VISUALIZATION: Scatterplot (per PI request)
# -----------------------------------------------------------------------------
plot_scatter_agreement <- ggplot(data_paired, 
                                  aes(x = MEMs_TimeSinceWaking, 
                                      y = Booklet_TimeSinceWaking)) +
  geom_point(alpha = 0.5, color = "steelblue") +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "red", linewidth = 1) +
  geom_smooth(method = "lm", se = TRUE, color = "darkblue", linewidth = 0.8) +
  labs(
    title = "Agreement Between Booklet and MEMs Recording Times",
    subtitle = paste0("Pearson r = ", round(correlation_test$estimate, 3),
                      " (95% CI: ", round(correlation_test$conf.int[1], 3), 
                      " to ", round(correlation_test$conf.int[2], 3), ")"),
    x = "MEMs Time Since Waking (minutes)",
    y = "Booklet Time Since Waking (minutes)"
  ) +
  annotate("text", x = max(data_paired$MEMs_TimeSinceWaking, na.rm = TRUE) * 0.2, 
           y = max(data_paired$Booklet_TimeSinceWaking, na.rm = TRUE) * 0.9,
           label = "Identity line (y = x)", color = "red", size = 3.5) +
  coord_equal() +
  theme(plot.subtitle = element_text(size = 10))

print(plot_scatter_agreement)
ggsave("Q1_scatterplot_agreement.png", plot_scatter_agreement, width = 8, height = 8, dpi = 150)

# -----------------------------------------------------------------------------
# 3.7 VISUALIZATION: Bland-Altman Plot
# -----------------------------------------------------------------------------
plot_bland_altman <- ggplot(data_paired, aes(x = Time_Average, y = Time_Difference)) +
  geom_point(alpha = 0.5, color = "steelblue") +
  geom_hline(yintercept = mean_diff, color = "blue", linewidth = 1) +
  geom_hline(yintercept = LoA_lower, color = "red", linetype = "dashed", linewidth = 0.8) +
  geom_hline(yintercept = LoA_upper, color = "red", linetype = "dashed", linewidth = 0.8) +
  geom_hline(yintercept = 0, color = "gray40", linetype = "dotted") +
  labs(
    title = "Bland-Altman Plot: Agreement Between Booklet and MEMs",
    subtitle = paste0("Bias = ", round(mean_diff, 2), " min; ",
                      "95% LoA: ", round(LoA_lower, 2), " to ", round(LoA_upper, 2), " min"),
    x = "Average of Booklet and MEMs Time Since Waking (minutes)",
    y = "Difference (Booklet - MEMs) in minutes"
  ) +
  annotate("text", x = max(data_paired$Time_Average, na.rm = TRUE) * 0.85, 
           y = mean_diff + 2, label = paste("Mean =", round(mean_diff, 2)), 
           color = "blue", size = 3.5) +
  annotate("text", x = max(data_paired$Time_Average, na.rm = TRUE) * 0.85, 
           y = LoA_upper + 2, label = paste("+1.96 SD =", round(LoA_upper, 2)), 
           color = "red", size = 3.5) +
  annotate("text", x = max(data_paired$Time_Average, na.rm = TRUE) * 0.85, 
           y = LoA_lower - 2, label = paste("-1.96 SD =", round(LoA_lower, 2)), 
           color = "red", size = 3.5) +
  theme(plot.subtitle = element_text(size = 10))

print(plot_bland_altman)
ggsave("Q1_bland_altman.png", plot_bland_altman, width = 10, height = 7, dpi = 150)

```
```{r}
# Q1 Mixed model
model_agreement <- lmer(Booklet_TimeSinceWaking ~ MEMs_TimeSinceWaking + (1|SubjectID), 
                        data = data_paired)
summary(model_agreement)
```
```{r}

# Q2 

# Define target times (in minutes since waking)
TARGET_SAMPLE2 <- 30    # 30 minutes after waking
TARGET_SAMPLE4 <- 600   # 600 minutes (10 hours) after waking

# Filter to samples 2 and 4 only, and require MEMs time to be present
data_adherence <- data %>%
  filter(CollectionSample %in% c(2, 4)) %>%
  filter(!is.na(MEMs_TimeSinceWaking)) %>%
  mutate(
    # Define target time based on sample
    Target_Time = case_when(
      CollectionSample == 2 ~ TARGET_SAMPLE2,
      CollectionSample == 4 ~ TARGET_SAMPLE4
    ),
    # Calculate deviation from target
    Deviation = MEMs_TimeSinceWaking - Target_Time,
    Abs_Deviation = abs(Deviation),
    # Adherence flags
    Within_7.5min = Abs_Deviation <= 7.5,
    Within_15min = Abs_Deviation <= 15,
    # Label for reporting
    Sample_Label = case_when(
      CollectionSample == 2 ~ "+30 min",
      CollectionSample == 4 ~ "+10 hours"
    )
  )

# =============================================================================
# CALCULATE ADHERENCE PERCENTAGES WITH 95% CONFIDENCE INTERVALS
# =============================================================================

# Function to calculate adherence with exact binomial CI
calc_adherence <- function(data, sample_num, window_min) {
  
  subset_data <- data %>% filter(CollectionSample == sample_num)
  n <- nrow(subset_data)
  
  if (window_min == 7.5) {
    x <- sum(subset_data$Within_7.5min)
  } else {
    x <- sum(subset_data$Within_15min)
  }
  
  # Exact binomial CI
  ci <- binom.test(x, n, conf.level = 0.95)
  
  return(data.frame(
    Sample = ifelse(sample_num == 2, "+30 min", "+10 hours"),
    Target_Time = ifelse(sample_num == 2, "30 min", "600 min"),
    Window = paste0("±", window_min, " min"),
    N_Total = n,
    N_Adherent = x,
    Percentage = round(100 * x / n, 1),
    CI_Lower = round(100 * ci$conf.int[1], 1),
    CI_Upper = round(100 * ci$conf.int[2], 1)
  ))
}

# Calculate for all combinations
adherence_results <- bind_rows(
  calc_adherence(data_adherence, 2, 7.5),
  calc_adherence(data_adherence, 2, 15),
  calc_adherence(data_adherence, 4, 7.5),
  calc_adherence(data_adherence, 4, 15)
)

print(adherence_results)

```

```{r}
# Q3

# Find all observations at detection limit
obs_at_limit <- data %>%
  filter(DHEA_AtDetectionLimit) %>%
  select(SubjectID, DayNumber, CollectionSample, DHEA_nmolL)

print(obs_at_limit)

KNOT<-30

data_Q3 <- data %>%
  filter(!DHEA_AtDetectionLimit) %>%                    # Remove obs at detection limit
  filter(SubjectID!=3037) %>%               # Remove subjects with multiple at limit
  filter(!is.na(DHEA_nmolL)) %>%               # Remove subjects with multiple at limit
  filter(Cortisol_nmolL<=80)    %>%                       # Remove extreme cortisol values
  filter(!is.na(MEMs_TimeSinceWaking)) %>%
  filter(MEMs_TimeSinceWaking>= 0) %>%
  mutate(
    Time = MEMs_TimeSinceWaking,
    Time1 = pmin(Time, KNOT),
    Time2 = pmax(Time - KNOT, 0),)


# Model: Cortisol ~ Time1 + Time2 + (1|SubjectID) + (1|SubjectID:DayNumber)
# 
# Interpretation:
# - Intercept: Expected cortisol at waking (Time = 0)
# - Time1 coefficient: Rate of change from waking to 30 min (awakening response)
# - Time2 coefficient: Rate of change after 30 min (decline phase)

model_cortisol_pw <- lmer(
  Cortisol_nmolL ~ Time1 + Time2 + (1|SubjectID_Factor),
  data = data_Q3
)

# without random intercept
model_cortisol_pw2 <- lm(
  Cortisol_nmolL ~ Time1 + Time2,
  data = data_Q3
)

AIC(model_cortisol_pw, model_cortisol_pw2)

summary(model_cortisol_pw)

# --- Model 2: Add quadratic term for Time1 (0-30 min phase) ---
data_Q3 <- data_Q3 %>%
  mutate(
    Time1_sq = Time1^2,
    Time2_sq = Time2^2
  )
model_linear<- model_cortisol_pw
model_quad_time1 <- lmer(Cortisol_nmolL ~ Time1 + Time1_sq + Time2 + (1|SubjectID_Factor), data = data_Q3)

# --- Model 3: Add quadratic term for Time2 (post-30 min phase) ---
model_quad_time2 <- lmer(Cortisol_nmolL ~ Time1 + Time2 + Time2_sq + (1|SubjectID_Factor), data = data_Q3)

# --- Model 4: Quadratic terms for both phases ---
model_quad_both <- lmer(Cortisol_nmolL ~ Time1 + Time1_sq + Time2 + Time2_sq + (1|SubjectID_Factor), data = data_Q3)

# --- Model 5: Simple quadratic (no piecewise, just Time + Time^2) ---
data_Q3 <- data_Q3 %>%
  mutate(Time_sq = Time^2)
model_simple_quad <- lmer(Cortisol_nmolL ~ Time + Time_sq + + (1|SubjectID_Factor), data = data_Q3)

# Create comparison table
model_comparison <- data.frame(
  Model = c(
    "1. Piecewise Linear",
    "2. Piecewise + Quad(Time1)",
    "3. Piecewise + Quad(Time2)",
    "4. Piecewise + Quad(Both)",
    "5. Simple Quadratic"
  ),
  Formula = c(
    "Y ~ Time1 + Time2",
    "Y ~ Time1 + Time1² + Time2",
    "Y ~ Time1 + Time2 + Time2²",
    "Y ~ Time1 + Time1² + Time2 + Time2²",
    "Y ~ Time + Time²"
  ),
  R2 = c(
    summary(model_linear)$r.squared,
    summary(model_quad_time1)$r.squared,
    summary(model_quad_time2)$r.squared,
    summary(model_quad_both)$r.squared,
    summary(model_simple_quad)$r.squared
  ),
  Adj_R2 = c(
    summary(model_linear)$adj.r.squared,
    summary(model_quad_time1)$adj.r.squared,
    summary(model_quad_time2)$adj.r.squared,
    summary(model_quad_both)$adj.r.squared,
    summary(model_simple_quad)$adj.r.squared
  ),
  AIC = c(
    AIC(model_linear),
    AIC(model_quad_time1),
    AIC(model_quad_time2),
    AIC(model_quad_both),
    AIC(model_simple_quad)
  ),
  BIC = c(
    BIC(model_linear),
    BIC(model_quad_time1),
    BIC(model_quad_time2),
    BIC(model_quad_both),
    BIC(model_simple_quad)
  )
)

# Format and print
model_comparison <- model_comparison %>%
  mutate(
    R2 = round(R2, 4),
    Adj_R2 = round(Adj_R2, 4),
    AIC = round(AIC, 2),
    BIC = round(BIC, 2)
  )

print(model_comparison)
```

```{r}
# Q3 model diagnostics

# Extract fitted values and residuals
data_Q3 <- data_Q3 %>%
  mutate(
    Fitted = fitted(model_cortisol_pw2),
    Residuals = residuals(model_cortisol_pw2),
    Std_Residuals = rstandard(model_cortisol_pw2)
  )

# =============================================================================
# 1. RESIDUALS VS FITTED VALUES
# =============================================================================

plot_resid_vs_fitted <- ggplot(data_Q3, aes(x = Fitted, y = Residuals)) +
  geom_point(alpha = 0.5, color = "steelblue") +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed", linewidth = 1) +
  geom_smooth(method = "loess", se = FALSE, color = "darkblue", linewidth = 0.8) +
  labs(
    title = "Residuals vs Fitted Values",
    subtitle = "Check for: constant spread (homoscedasticity), no curved pattern",
    x = "Fitted Values (nmol/L)",
    y = "Residuals"
  ) +
  theme_bw()

print(plot_resid_vs_fitted)
ggsave("Diag_1_Residuals_vs_Fitted.png", plot_resid_vs_fitted, width = 8, height = 6, dpi = 150)

# =============================================================================
# 2. RESIDUALS VS TIME
# =============================================================================

KNOT <- 30

plot_resid_vs_time <- ggplot(data_Q3, aes(x = Time, y = Residuals)) +
  geom_point(alpha = 0.5, color = "steelblue") +
  geom_hline(yintercept = 0, color = "red", linetype = "dashed", linewidth = 1) +
  geom_smooth(method = "loess", se = FALSE, color = "darkblue", linewidth = 0.8) +
  geom_vline(xintercept = KNOT, linetype = "dotted", color = "darkgreen", linewidth = 0.8) +
  annotate("text", x = KNOT + 15, y = max(data_Q3$Residuals, na.rm = TRUE) * 0.9,
           label = "Knot = 30 min", color = "darkgreen", hjust = 0, size = 3.5) +
  labs(
    title = "Residuals vs Time Since Waking",
    subtitle = "Check for: no systematic pattern, especially around the knot",
    x = "Time Since Waking (minutes)",
    y = "Residuals"
  ) +
  theme_bw()

print(plot_resid_vs_time)

plot_qq <- ggplot(data_Q3, aes(sample = Std_Residuals)) +
  stat_qq(alpha = 0.5, color = "steelblue") +
  stat_qq_line(color = "red", linewidth = 1) +
  labs(
    title = "Q-Q Plot of Standardized Residuals",
    subtitle = "Check for: points following the diagonal line (normality)",
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  ) +
  theme_bw()

print(plot_qq)

# Calculate R-squared for annotation
r_squared <- summary(model_cortisol_pw2)$r.squared

plot_pred_vs_obs <- ggplot(data_Q3, aes(x = Fitted, y = Cortisol_nmolL)) +
  geom_point(alpha = 0.5, color = "steelblue") +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed", linewidth = 1) +
  geom_smooth(method = "lm", se = FALSE, color = "darkblue", linewidth = 0.8) +
  annotate("text", 
           x = min(data_Q3$Fitted, na.rm = TRUE) + 1,
           y = max(data_Q3$Cortisol_nmolL, na.rm = TRUE) * 0.95,
           label = paste0("R² = ", round(r_squared, 3)),
           hjust = 0, size = 4, color = "darkblue") +
  labs(
    title = "Predicted vs Observed Cortisol",
    subtitle = "Red dashed = perfect prediction (y = x); Blue = actual fit",
    x = "Predicted Cortisol (nmol/L)",
    y = "Observed Cortisol (nmol/L)"
  ) +
  coord_equal() +
  theme_bw()

print(plot_pred_vs_obs)


plot_cortisol_2 <- ggplot(data_Q3, aes(x = Time, y = Cortisol_nmolL, color = factor(CollectionSample))) +
  geom_point(alpha = 0.6, size = 2) +
  geom_vline(xintercept = KNOT, linetype = "dashed", color = "gray40", linewidth = 0.8) +
  scale_color_manual(
    values = c("1" = "#E41A1C", "2" = "#377EB8", "3" = "#4DAF4A", "4" = "#984EA3"),
    labels = c("1" = "Waking", "2" = "30 min", "3" = "Lunch", "4" = "10 hours"),
    name = "Collection Sample"
  ) +
  labs(
    title = "Cortisol Over Time by Collection Sample",
    subtitle = "Each color represents a different scheduled sampling time",
    x = "Time Since Waking (minutes)",
    y = "Cortisol (nmol/L)"
  ) +
  theme_bw(base_size = 12) +
  theme(legend.position = "bottom")

print(plot_cortisol_2)

# --- Plot 2a: DHEA vs Time with LOESS ---
plot_dhea_1 <- ggplot(data_Q3, aes(x = Time, y = DHEA_nmolL)) +
  geom_point(alpha = 0.4, color = "forestgreen") +
  geom_smooth(method = "loess", se = TRUE, color = "darkgreen", linewidth = 1, span = 0.3) +
  geom_vline(xintercept = KNOT, linetype = "dashed", color = "red", linewidth = 0.8) +
  annotate("text", x = KNOT + 15, y = max(data_Q3$DHEA_nmolL, na.rm = TRUE) * 0.95,
           label = "Knot = 30 min", color = "red", hjust = 0, size = 3.5) +
  labs(
    title = "DHEA Over Time Since Waking",
    subtitle = "Green line = LOESS smooth with 95% CI",
    x = "Time Since Waking (minutes)",
    y = "DHEA (nmol/L)"
  ) +
  theme_bw(base_size = 12)

print(plot_dhea_1)
```